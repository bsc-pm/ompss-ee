FC	= gfortran
CC	= mnvcc
CFLAGS	= --ompss -k
CFLAGS += --Wx:cuda:n

DPREC	= -DDOUBLE_PREC
CFLAGS += $(DPREC)
FFLAGS	= $(DPREC)

MKL += -I/opt/compilers/intel/mkl/include -L /opt/compilers/intel/mkl/lib/intel64 -lmkl_sequential -lmkl_core -lmkl_rt /opt/compilers/intel/lib/intel64/libirc.a

# BLAS & LAPACK libraries
LIB_LAPACK = -L/gpfs/apps/NVIDIA/LAPACK/3.3.1/lib -llapack -lpthread -lgfortran 
LIB_BLAS = $(MKL)
LIB_CUBLAS = -lcublas 

# MAGMA
INCS = $(CUDAINC) $(INC_POTRF)
LIBS = $(LIB_CUBLAS) $(LIB_BLAS) $(LIB_POTRF)

# CUDA directory
#CUDAINC	= -I /usr/local/cuda/include

# Uncomment to debug or instrument user code
#DEBUG = --debug -g2 -ggdb3 -k #-lprofiler -DPROFILE #-O0
INSTR	= --instrument

CFLAGS	+= $(DEBUG) $(INSTR)

# Intermediate files generated by the compiler (which are not removed when using -k flag)
COMP_FILES = cudacc_*.* $(CC)_*.*


SOBJ = cuda_potrf.o

APP	= cholesky_hyb

all: $(APP) cholesky_hyb

$(APP): cholesky_hyb.c $(SOBJ)
	$(CC) $(CFLAGS) $< $(SOBJ) $(INCS) $(LIBS) \
	--Wx:cuda:n,$(CUDAINC),-include,cublas.h $(CUDA_MAGMA) \
        -o $(APP) \
	$(END)

cuda_potrf.o: cuda_potrf.cu
	nvcc -arch=sm_13 -c $<

clean:
	rm -rf *.o $(COMP_FILES) $(APP) nested_hyb



#$ nvcc -O3 sscc_cholesky.c cuspotf2.o cuspotrf.o fortran.o cudacc_cholesky.o -L/opt/amd64/cuda/lib64 -lcublas -L/usr/lib64 -llapack -lpthread -lgfortran -I/opt/amd64/cuda/include -o cholesky -I/home/users/jplanas/GPUSs_dev/include/nanox/ -L/home/users/jplanas/GPUSs_dev/lib -lnanox-c
